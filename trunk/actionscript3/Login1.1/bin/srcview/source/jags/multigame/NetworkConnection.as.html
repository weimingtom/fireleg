<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>NetworkConnection.as</title>
<link rel="stylesheet" type="text/css" href="../../../SourceStyles.css"/>
</head>

<body><pre><span class="asPackage">package</span> jags.multigame 
<span class="asBracket">{</span>
    <span class="asComment">// Written by Travis Somerville    
</span>
    <span class="asReserved">import</span> flash.net.Socket;
    <span class="asReserved">import</span> flash.events.Event;
    <span class="asReserved">import</span> flash.events.EventDispatcher;
    <span class="asReserved">import</span> flash.events.ProgressEvent;
<span class="asComment">//    import mx.controls.TextArea;
</span><span class="asComment">//    import mx.utils.StringUtil;
</span>    <span class="asReserved">import</span> flash.system.Security;
    <span class="asReserved">import</span> mx.controls.Alert;
    <span class="asReserved">import</span> flash.events.ErrorEvent;
    <span class="asReserved">import</span> flash.events.IOErrorEvent;
    <span class="asReserved">import</span> flash.errors.IOError;    
    
    <span class="asReserved">public</span> <span class="asClass">class</span> NetworkConnection <span class="asReserved">extends</span> EventDispatcher <span class="asBracket">{</span>        
        <span class="asDoc">/****************************************
         * USAGE: Set to true for games that 
         * do not use any network at all.
         ***************************************/</span>
        <span class="asReserved">public</span> <span class="asVar">var</span> BypassNetwork<span class="asOperator">:</span>Boolean <span class="asOperator">=</span> <span class="asReserved">false</span>;
         
        <span class="asDoc">/**************************************************
         * These events are sent to anyone listening.
         * They are the important actions from the server.
         **************************************************/</span>
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> StartGameEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!start_game&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> JoinedHostEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!joined_host&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> GroupNameReceivedEvent<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;!name_group&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> IDReceivedEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!your_id&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> YouHostEvent<span class="asOperator">:</span>String             <span class="asOperator">=</span> <span class="asString">&quot;!you_host&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> AddPlayerEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!add_player&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> GroupSizeEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!group_size&quot;</span>;        
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> GameCommandEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!game_command&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> SocketOpenEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!connected&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> DisconnectedEvent<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!disconnected&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> RemovePlayer<span class="asOperator">:</span>String            <span class="asOperator">=</span> <span class="asString">&quot;!remove_connection&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> WarmedUpEvent<span class="asOperator">:</span>String            <span class="asOperator">=</span> <span class="asString">&quot;!warmed_up&quot;</span>;
        
        <span class="asDoc">/*****************************************************
         * These are the various destinations for a message
         ****************************************************/</span>
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> TELL_ALL<span class="asOperator">:</span>String         <span class="asOperator">=</span> <span class="asString">&quot;!ALL&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> TELL_OTHERS<span class="asOperator">:</span>String     <span class="asOperator">=</span> <span class="asString">&quot;!Others&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> TELL_SERVER<span class="asOperator">:</span>String    <span class="asOperator">=</span> <span class="asString">&quot;!Server&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> TELL_GROUP<span class="asOperator">:</span>String    <span class="asOperator">=</span> <span class="asString">&quot;!Group&quot;</span>;
        
        <span class="asDoc">/*****************************************************
         * These are the various formats for the data
         ****************************************************/</span>
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> FORMAT_TEXT<span class="asOperator">:</span>String     <span class="asOperator">=</span> <span class="asString">&quot;text&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> FORMAT_XML4<span class="asOperator">:</span>String     <span class="asOperator">=</span> <span class="asString">&quot;xml4&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> FORMAT_AMF3<span class="asOperator">:</span>String     <span class="asOperator">=</span> <span class="asString">&quot;amf3&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> FORMAT_BASE64<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;Bx64&quot;</span>;
        
        <span class="asReserved">private</span> <span class="asVar">var</span> e<span class="asOperator">:</span>Event;
         
        <span class="asReserved">private</span> <span class="asVar">var</span> socket<span class="asOperator">:</span>Socket;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>     <span class="asVar">var</span> connected<span class="asOperator">:</span>Boolean <span class="asOperator">=</span> <span class="asReserved">false</span>;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> msgCount<span class="asOperator">:</span> uint <span class="asOperator">=</span> 0;        
        
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> receivedId<span class="asOperator">:</span>Boolean <span class="asOperator">=</span> <span class="asReserved">false</span>;  
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> id<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;no_id&quot;</span><span class="asOperator">+</span> Math.random<span class="asBracket">()</span>;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> groupName<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;!ALL&quot;</span>;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>     <span class="asVar">var</span> isHost<span class="asOperator">:</span>Boolean <span class="asOperator">=</span> <span class="asReserved">false</span>;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> hostConnID<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;&quot;</span>;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> numberOfPlayers<span class="asOperator">:</span>int <span class="asOperator">=</span> 1;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> connectedToHost<span class="asOperator">:</span>Boolean <span class="asOperator">=</span> <span class="asReserved">false</span>;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span>    <span class="asVar">var</span> gameStarted<span class="asOperator">:</span>Boolean <span class="asOperator">=</span> <span class="asReserved">false</span>;
         
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> DELIMITER<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;:&quot;</span>;
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asVar">var</span> HEADER_DELIMITER<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;&gt;&quot;</span>;
        <span class="asReserved">private</span> <span class="asVar">var</span> word<span class="asOperator">:</span>String;
        
        <span class="asReserved">public</span> <span class="asVar">var</span> URL<span class="asOperator">:</span>String;
        <span class="asReserved">public</span>     <span class="asVar">var</span> port<span class="asOperator">:</span>uint;
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span> <span class="asVar">var</span> gameName<span class="asOperator">:</span>String;
        
        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span> <span class="asVar">var</span> lastMessageIn<span class="asOperator">:</span>String;  <span class="asComment">// from Server
</span>        <span class="asBracket">[</span><span class="asMetadata">Bindable</span><span class="asBracket">]</span> <span class="asReserved">public</span> <span class="asVar">var</span> lastMessageOut<span class="asOperator">:</span>String;  <span class="asComment">// To Server        
</span>        
        <span class="asReserved">public</span> <span class="asFunction">function</span> NetworkConnection<span class="asBracket">(</span>gameName<span class="asOperator">:</span>String, URL<span class="asOperator">:</span>String, port<span class="asOperator">:</span>uint, IDCallback<span class="asOperator">:</span>Function<span class="asBracket">)</span> <span class="asBracket">{</span>
            <span class="asReserved">this</span>.URL <span class="asOperator">=</span> URL;
            <span class="asReserved">this</span>.port <span class="asOperator">=</span> port;
            <span class="asReserved">this</span>.gameName <span class="asOperator">=</span> gameName;    
            
            <span class="asReserved">if</span> <span class="asBracket">(</span><span class="asOperator">!</span>BypassNetwork<span class="asBracket">)</span> <span class="asBracket">{</span>
                socket <span class="asOperator">=</span> <span class="asReserved">new</span> Socket<span class="asBracket">()</span>;
                socket.addEventListener<span class="asBracket">(</span>IOErrorEvent.IO_ERROR, handleIOError<span class="asBracket">)</span>;
                socket.addEventListener<span class="asBracket">(</span>Event.CONNECT, onConnect<span class="asBracket">)</span>;
                socket.addEventListener<span class="asBracket">(</span>ProgressEvent.SOCKET_DATA, onSocketData<span class="asBracket">)</span>;
                socket.addEventListener<span class="asBracket">(</span>Event.CLOSE, onClose<span class="asBracket">)</span>;                      
                <span class="asReserved">this</span>.addEventListener<span class="asBracket">(</span>IDReceivedEvent, IDCallback<span class="asBracket">)</span>;                                    
            <span class="asBracket">}</span>                            
        <span class="asBracket">}</span>
        
        <span class="asReserved">private</span> <span class="asFunction">function</span> handleIOError<span class="asBracket">(</span>io<span class="asOperator">:</span>IOErrorEvent<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            Alert.show<span class="asBracket">(</span><span class="asString">&quot;Problem connecting to game &quot;</span><span class="asOperator">+</span> gameName <span class="asOperator">+</span><span class="asString">&quot;\n\nPlease check: \n1)network cable \n2)server running at &quot;</span><span class="asOperator">+</span> URL <span class="asOperator">+</span><span class="asString">&quot;:&quot;</span><span class="asOperator">+</span> port<span class="asBracket">)</span>;
        <span class="asBracket">}</span>
            
        <span class="asDoc">/****************************************************
         * Sends game commands that are specific to hosting
         * and joining games.
         ***************************************************/</span>
         <span class="asReserved">public</span> <span class="asFunction">function</span> getID<span class="asBracket">()</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
             sayServer<span class="asBracket">(</span><span class="asString">&quot;!whats_my_name&quot;</span>, <span class="asString">&quot;&quot;</span><span class="asBracket">)</span>;    
         <span class="asBracket">}</span>    
         
         <span class="asReserved">public</span> <span class="asFunction">function</span> autoJoin<span class="asBracket">(</span>numberOfPlayers<span class="asOperator">:</span>int<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
             sayServer<span class="asBracket">(</span><span class="asString">&quot;!auto_match&quot;</span><span class="asOperator">+</span> DELIMITER <span class="asOperator">+</span> numberOfPlayers, <span class="asString">&quot;&quot;</span><span class="asBracket">)</span>;
         <span class="asBracket">}</span>
          
         <span class="asReserved">public</span> <span class="asFunction">function</span> startGame<span class="asBracket">(</span>numberOfPlayers<span class="asOperator">:</span>int<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
             sayServer<span class="asBracket">(</span><span class="asString">&quot;!start_game&quot;</span><span class="asOperator">+</span> DELIMITER <span class="asOperator">+</span> numberOfPlayers, <span class="asString">&quot;&quot;</span><span class="asBracket">)</span>;
         <span class="asBracket">}</span>
                          
        <span class="asDoc">/****************************************************
         * Listens to game server and passes game commands
         * to data listener.
         ***************************************************/</span>    
        <span class="asReserved">public</span> <span class="asFunction">function</span> onSocketData<span class="asBracket">(</span>event<span class="asOperator">:</span>ProgressEvent<span class="asBracket">)</span><span class="asOperator">:</span>String <span class="asBracket">{</span>
            <span class="asVar">var</span> valid<span class="asOperator">:</span>Boolean;
            <span class="asVar">var</span> length<span class="asOperator">:</span>int;    
            
            lastMessageIn <span class="asOperator">=</span> socket.readUTFBytes<span class="asBracket">(</span>socket.bytesAvailable<span class="asBracket">)</span>;
            <span class="asComment">//trace(&quot;IN: &quot;+ lastMessageIn);
</span>            
            <span class="asComment">// -----------------------------------------
</span>            <span class="asComment">// Split data into single commands
</span>            <span class="asComment">// -----------------------------------------
</span>            <span class="asVar">var</span> lines<span class="asOperator">:</span>Array <span class="asOperator">=</span> lastMessageIn.split<span class="asBracket">(</span><span class="asString">&quot;\n&quot;</span><span class="asBracket">)</span>;
            <span class="asReserved">for</span><span class="asBracket">(</span><span class="asVar">var</span> oneCommand<span class="asOperator">:</span>String <span class="asReserved">in</span> lines<span class="asBracket">)</span> <span class="asBracket">{</span>
                word <span class="asOperator">=</span> lines<span class="asBracket">[</span>oneCommand<span class="asBracket">]</span>.toString<span class="asBracket">()</span>;
                length <span class="asOperator">=</span> word.length;
                <span class="asReserved">if</span> <span class="asBracket">(</span>word <span class="asOperator">!=</span> <span class="asString">&quot;&quot;</span> <span class="asOperator">&amp;&amp;</span> word <span class="asOperator">!=</span> <span class="asString">&quot;\n&quot;</span><span class="asBracket">)</span> <span class="asBracket">{</span>
                    msgCount<span class="asOperator">++</span>;
                    
                    <span class="asComment">// First message means server connection is really ready.
</span>                    <span class="asReserved">if</span> <span class="asBracket">(</span>msgCount <span class="asOperator">==</span> 1<span class="asBracket">)</span> <span class="asBracket">{</span>    
                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>WarmedUpEvent<span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;
                    <span class="asBracket">}</span>
                    
                    connected <span class="asOperator">=</span> <span class="asReserved">true</span>;
                    word <span class="asOperator">=</span> word.replace<span class="asBracket">(</span><span class="asString">&quot;\r&quot;</span>, <span class="asString">&quot;&quot;</span><span class="asBracket">)</span>;
                    
                    <span class="asComment">// -----------------------------------------
</span>                    <span class="asComment">// Core protocol, not game commands
</span>                    <span class="asComment">// -----------------------------------------
</span>                    <span class="asVar">var</span> parts<span class="asOperator">:</span>Array;
                    <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span><span class="asString">&quot;!ru_alive&quot;</span><span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        <span class="asComment">// send a response back to server to prove we are here
</span>                        sayServer<span class="asBracket">(</span><span class="asString">&quot;!iam_alive&quot;</span>, <span class="asString">&quot;&quot;</span><span class="asBracket">)</span>;
                    <span class="asBracket">}</span>
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span><span class="asString">&quot;!what_is_your_game&quot;</span><span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        sayServer<span class="asBracket">(</span><span class="asString">&quot;!set_my_game&quot;</span> <span class="asOperator">+</span> DELIMITER <span class="asOperator">+</span> gameName, <span class="asString">&quot;&quot;</span><span class="asBracket">)</span>;
                    <span class="asBracket">}</span>
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span>GroupNameReceivedEvent<span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        parts <span class="asOperator">=</span> word.split<span class="asBracket">(</span>DELIMITER<span class="asBracket">)</span>;
                        groupName <span class="asOperator">=</span> parts<span class="asBracket">[</span>1<span class="asBracket">]</span>;
                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>GroupNameReceivedEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;                        
                    <span class="asBracket">}</span>
                    <span class="asComment">//else if (word.indexOf(RemovePlayer) &gt; -1) {
</span>                    <span class="asComment">//    parts = word.split(DELIMITER);
</span>                    <span class="asComment">//    var playerToRemove:String = parts[1];
</span>                        
                    <span class="asComment">//}
</span>                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span>IDReceivedEvent<span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        parts <span class="asOperator">=</span> word.split<span class="asBracket">(</span>DELIMITER<span class="asBracket">)</span>;
                        <span class="asReserved">this</span>.id <span class="asOperator">=</span> parts<span class="asBracket">[</span>1<span class="asBracket">]</span>;
                        receivedId <span class="asOperator">=</span> <span class="asReserved">true</span>;
                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>IDReceivedEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;    
                    <span class="asBracket">}</span>
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span>YouHostEvent<span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        parts <span class="asOperator">=</span> word.split<span class="asBracket">(</span>DELIMITER<span class="asBracket">)</span>;
                        isHost <span class="asOperator">=</span> <span class="asReserved">true</span>;
                        connectedToHost <span class="asOperator">=</span> <span class="asReserved">true</span>;
                        hostConnID <span class="asOperator">=</span> parts<span class="asBracket">[</span>1<span class="asBracket">]</span>;
                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>YouHostEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;                        
                    <span class="asBracket">}</span>
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span>AddPlayerEvent<span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        <span class="asComment">//numberOfPlayers ++;
</span>                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>AddPlayerEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;                    
                    <span class="asBracket">}</span>                        
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span>GroupSizeEvent<span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        parts <span class="asOperator">=</span> word.split<span class="asBracket">(</span>DELIMITER<span class="asBracket">)</span>;
                        numberOfPlayers <span class="asOperator">=</span> parts<span class="asBracket">[</span>1<span class="asBracket">]</span>;
                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>GroupSizeEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;                    
                    <span class="asBracket">}</span>                    
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span>JoinedHostEvent<span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        parts <span class="asOperator">=</span> word.split<span class="asBracket">(</span>DELIMITER<span class="asBracket">)</span>;
                        hostConnID <span class="asOperator">=</span> parts<span class="asBracket">[</span>1<span class="asBracket">]</span>;
                        connectedToHost <span class="asOperator">=</span> <span class="asReserved">true</span>;
                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>JoinedHostEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;                        
                    <span class="asBracket">}</span>    
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span>StartGameEvent<span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        <span class="asComment">//parts = word.split(DELIMITER);
</span>                        <span class="asComment">//numberOfPlayers = parts[1];
</span>                        gameStarted <span class="asOperator">=</span> <span class="asReserved">true</span>;    
                        e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>StartGameEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
                        dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;
                    <span class="asBracket">}</span>
                    <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span>word.indexOf<span class="asBracket">(</span><span class="asString">&quot;&lt;cross-domain-policy&gt;&quot;</span><span class="asBracket">)</span> <span class="asOperator">&gt;</span> <span class="asOperator">-</span>1<span class="asBracket">)</span> <span class="asBracket">{</span>
                        <span class="asTrace">trace</span><span class="asBracket">(</span><span class="asString">&quot;Your sandbox is trusted and you can ignore this: &quot;</span><span class="asOperator">+</span> word<span class="asBracket">)</span>;
                    <span class="asBracket">}</span>
                    <span class="asReserved">else</span> <span class="asBracket">{</span>                            
                        announceGameEvent<span class="asBracket">(</span>word<span class="asBracket">)</span>;            
                    <span class="asBracket">}</span>        
                <span class="asBracket">}</span>                    
            <span class="asBracket">}</span>
            
            <span class="asReserved">return</span> lastMessageIn;
        <span class="asBracket">}</span>
        
        <span class="asComment">// Sends this message to your Actionscript game client
</span>        <span class="asComment">// if you added listeners for the command.
</span>        <span class="asReserved">public</span> <span class="asFunction">function</span> announceGameEvent<span class="asBracket">(</span>gameData<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>

            <span class="asComment">// --------------------------------------------
</span>            <span class="asComment">// Notify the any listeners of the message.
</span>            <span class="asComment">// In other words, your game gets the message.
</span>            <span class="asComment">// --------------------------------------------                                            
</span>            <span class="asVar">var</span> data<span class="asOperator">:</span>String;
            <span class="asVar">var</span> name<span class="asOperator">:</span>String;
            <span class="asVar">var</span> type<span class="asOperator">:</span>String    
            <span class="asVar">var</span>    timeStamp<span class="asOperator">:</span>Number <span class="asOperator">=</span> <span class="asOperator">-</span>1;
            <span class="asVar">var</span> from<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;&quot;</span>;                            
            <span class="asVar">var</span> command<span class="asOperator">:</span>String;            
            <span class="asVar">var</span> format<span class="asOperator">:</span>String;
            
            <span class="asComment">// EXTRACT Time&gt;From&gt;Format(text|XML4|AMF3|Bx64)&gt;Command&gt;Data (timeStamp is optional)
</span>            <span class="asVar">var</span> messageHeader<span class="asOperator">:</span>Array <span class="asOperator">=</span> gameData.split<span class="asBracket">(</span>NetworkConnection.HEADER_DELIMITER<span class="asBracket">)</span>;
            
            <span class="asReserved">if</span> <span class="asBracket">(</span>Config.useTimestamps <span class="asOperator">==</span> <span class="asReserved">true</span><span class="asBracket">)</span> timeStamp <span class="asOperator">=</span> messageHeader.shift<span class="asBracket">()</span>;

            from <span class="asOperator">=</span> messageHeader.shift<span class="asBracket">()</span> <span class="asReserved">as</span> String;
            format <span class="asOperator">=</span> messageHeader.shift<span class="asBracket">()</span> <span class="asReserved">as</span> String;
            <span class="asVar">var</span> remainder<span class="asOperator">:</span>String <span class="asOperator">=</span> messageHeader.shift<span class="asBracket">()</span> <span class="asReserved">as</span> String;
            <span class="asVar">var</span> temp<span class="asOperator">:</span>Array <span class="asOperator">=</span> remainder.split<span class="asBracket">(</span>DELIMITER<span class="asBracket">)</span>;
            command <span class="asOperator">=</span> temp.shift<span class="asBracket">()</span>;

            <span class="asReserved">if</span> <span class="asBracket">(</span>command <span class="asOperator">!=</span> <span class="asReserved">null</span> <span class="asOperator">&amp;&amp;</span> command.length <span class="asOperator">&gt;</span> 1<span class="asBracket">)</span> <span class="asBracket">{</span>
                <span class="asComment">//if (format == &quot;text&quot;) {
</span>                    data <span class="asOperator">=</span> temp.join<span class="asBracket">(</span>NetworkConnection.DELIMITER<span class="asBracket">)</span>;
                    e <span class="asOperator">=</span> <span class="asReserved">new</span> GameTextEvent<span class="asBracket">(</span>command, timeStamp, from, data<span class="asBracket">)</span>;
                    dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;
                <span class="asComment">//}                            
</span>            <span class="asBracket">}</span>            
        <span class="asBracket">}</span>

        <span class="asDoc">/***********************************************
         * Main function to send messages to server.
         * time&gt;from&gt;format&gt;to&gt;message
         **********************************************/</span>
        <span class="asReserved">public</span> <span class="asFunction">function</span> send<span class="asBracket">(</span>who<span class="asOperator">:</span>String, format<span class="asOperator">:</span>String, message<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>            
            <span class="asReserved">if</span> <span class="asBracket">(</span><span class="asOperator">!</span>BypassNetwork<span class="asBracket">)</span> message <span class="asOperator">=</span> who <span class="asOperator">+</span> NetworkConnection.HEADER_DELIMITER <span class="asOperator">+</span> message;

            message <span class="asOperator">=</span> id <span class="asOperator">+</span> NetworkConnection.HEADER_DELIMITER 
                    <span class="asOperator">+</span> format <span class="asOperator">+</span> NetworkConnection.HEADER_DELIMITER <span class="asOperator">+</span> message;
            
            <span class="asReserved">if</span> <span class="asBracket">(</span>Config.useTimestamps <span class="asOperator">==</span> <span class="asReserved">true</span><span class="asBracket">)</span> <span class="asBracket">{</span>
                <span class="asVar">var</span> time<span class="asOperator">:</span>Number <span class="asOperator">=</span> <span class="asReserved">new</span> Date<span class="asBracket">()</span>.time;
                message <span class="asOperator">=</span> time <span class="asOperator">+</span> NetworkConnection.HEADER_DELIMITER <span class="asOperator">+</span> message;
            <span class="asBracket">}</span>
            
            <span class="asComment">//trace(&quot;SENDING (&quot;+ format +&quot;) &quot;+ message);
</span>            lastMessageOut <span class="asOperator">=</span> message;
            
            <span class="asComment">// SEND via Internet or Locally
</span>            <span class="asReserved">if</span> <span class="asBracket">(</span><span class="asOperator">!</span>BypassNetwork<span class="asBracket">)</span> <span class="asBracket">{</span>
                socket.writeUTFBytes<span class="asBracket">(</span>message<span class="asBracket">)</span>;
                socket.flush<span class="asBracket">()</span>;
            <span class="asBracket">}</span>
            <span class="asReserved">else</span> 
                announceGameEvent<span class="asBracket">(</span>message<span class="asBracket">)</span>;
        <span class="asBracket">}</span>
        
        <span class="asDoc">/***************************************************************
         * Like send() but adds a newline and helps build your message.
         ***************************************************************/</span>
        <span class="asReserved">public</span> <span class="asFunction">function</span> sayServer<span class="asBracket">(</span>command<span class="asOperator">:</span>String, message<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asReserved">try</span> <span class="asBracket">{</span>
                send<span class="asBracket">(</span>TELL_SERVER, FORMAT_TEXT, command <span class="asOperator">+</span> HEADER_DELIMITER <span class="asOperator">+</span> message <span class="asOperator">+</span><span class="asString">&quot;\n&quot;</span><span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            <span class="asReserved">catch</span> <span class="asBracket">(</span>e<span class="asOperator">:</span>Error<span class="asBracket">)</span> <span class="asBracket">{}</span>
        <span class="asBracket">}</span>

        <span class="asReserved">public</span> <span class="asFunction">function</span> sayAll<span class="asBracket">(</span>command<span class="asOperator">:</span>String, message<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asReserved">try</span> <span class="asBracket">{</span>
                send<span class="asBracket">(</span>TELL_ALL, FORMAT_TEXT, command <span class="asOperator">+</span> DELIMITER <span class="asOperator">+</span> message <span class="asOperator">+</span><span class="asString">&quot;\n&quot;</span><span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            <span class="asReserved">catch</span> <span class="asBracket">(</span>e<span class="asOperator">:</span>Error<span class="asBracket">)</span> <span class="asBracket">{}</span>
        <span class="asBracket">}</span>
        
        <span class="asReserved">public</span> <span class="asFunction">function</span> sayOthers<span class="asBracket">(</span>command<span class="asOperator">:</span>String, message<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asReserved">try</span> <span class="asBracket">{</span>
                send<span class="asBracket">(</span>TELL_OTHERS, FORMAT_TEXT, command <span class="asOperator">+</span> DELIMITER <span class="asOperator">+</span> message <span class="asOperator">+</span><span class="asString">&quot;\n&quot;</span><span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            <span class="asReserved">catch</span> <span class="asBracket">(</span>e<span class="asOperator">:</span>Error<span class="asBracket">)</span> <span class="asBracket">{}</span>
        <span class="asBracket">}</span>
        
        <span class="asReserved">public</span> <span class="asFunction">function</span> saySelect<span class="asBracket">(</span>groups<span class="asOperator">:</span>String, command<span class="asOperator">:</span>String, message<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asReserved">try</span> <span class="asBracket">{</span>
                send<span class="asBracket">(</span>groups, FORMAT_TEXT, command <span class="asOperator">+</span> DELIMITER <span class="asOperator">+</span> message <span class="asOperator">+</span><span class="asString">&quot;\n&quot;</span><span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            <span class="asReserved">catch</span> <span class="asBracket">(</span>e<span class="asOperator">:</span>Error<span class="asBracket">)</span> <span class="asBracket">{}</span>
        <span class="asBracket">}</span>
        
        <span class="asReserved">public</span> <span class="asFunction">function</span> sayMyGroup<span class="asBracket">(</span>command<span class="asOperator">:</span>String, message<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asReserved">try</span> <span class="asBracket">{</span>
                send<span class="asBracket">(</span>groupName, FORMAT_TEXT, command <span class="asOperator">+</span> DELIMITER <span class="asOperator">+</span> message <span class="asOperator">+</span><span class="asString">&quot;\n&quot;</span><span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            <span class="asReserved">catch</span> <span class="asBracket">(</span>e<span class="asOperator">:</span>Error<span class="asBracket">)</span> <span class="asBracket">{}</span>
        <span class="asBracket">}</span>

        <span class="asDoc">/********************************************
         * Functions that make a solid connection
         * with the Game Server.
         ********************************************/</span>                                
        <span class="asReserved">private</span> <span class="asFunction">function</span> onConnect<span class="asBracket">(</span>event<span class="asOperator">:</span>Event <span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asTrace">trace</span><span class="asBracket">(</span><span class="asString">&quot;The socket is now connected, but not warmed up yet...&quot;</span><span class="asBracket">)</span>;
            connected <span class="asOperator">=</span> <span class="asReserved">true</span>;
            e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>SocketOpenEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
            dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;
            
            sayServer<span class="asBracket">(</span><span class="asString">&quot;Ping&quot;</span>, <span class="asString">&quot;&quot;</span><span class="asBracket">)</span>;    
            <span class="asReserved">this</span>.addEventListener<span class="asBracket">(</span>WarmedUpEvent, onWarmedUpHandler<span class="asBracket">)</span>;                                                
        <span class="asBracket">}</span>
        
        <span class="asReserved">public</span> <span class="asFunction">function</span> onWarmedUpHandler<span class="asBracket">(</span>event<span class="asOperator">:</span>Event<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asComment">// game client should listen for IDReceived.
</span>            <span class="asReserved">this</span>.getID<span class="asBracket">()</span>;
        <span class="asBracket">}</span>
        
        <span class="asReserved">public</span> <span class="asFunction">function</span> connect<span class="asBracket">()</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            <span class="asReserved">if</span> <span class="asBracket">(</span><span class="asOperator">!</span>connected<span class="asBracket">)</span> socket.connect<span class="asBracket">(</span>URL, port<span class="asBracket">)</span>;
            socket.flush<span class="asBracket">()</span>;
        <span class="asBracket">}</span>
        
        <span class="asReserved">public</span> <span class="asFunction">function</span> onClose<span class="asBracket">(</span>event<span class="asOperator">:</span>Event<span class="asBracket">)</span><span class="asOperator">:</span><span class="asReserved">void</span> <span class="asBracket">{</span>
            connected <span class="asOperator">=</span> <span class="asReserved">false</span>;
            e <span class="asOperator">=</span> <span class="asReserved">new</span> Event<span class="asBracket">(</span>DisconnectedEvent, <span class="asReserved">false</span>, <span class="asReserved">false</span><span class="asBracket">)</span>;
            dispatchEvent<span class="asBracket">(</span>e<span class="asBracket">)</span>;            
        <span class="asBracket">}</span>        
    <span class="asBracket">}</span>
<span class="asBracket">}</span></pre></body>
</html>
